<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
        <a href="/admin/research/<%= job.id %>" style="font-size:13px;color:var(--forest);text-decoration:underline;">&larr; Back to research results</a>
        <div style="display:flex;gap:8px;align-items:center;">
            <% if (ancestor.confidence_level !== 'Customer Data' && ancestor.ascendancy_number > 1) { %>
                <% if (!ancestor.accepted) { %>
                    <form action="/admin/research/<%= job.id %>/ancestor/<%= ancestor.id %>/accept" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-primary btn-sm">Accept</button>
                    </form>
                <% } else { %>
                    <span class="badge badge-success">Accepted &#10003;</span>
                <% } %>
                <form action="/admin/research/<%= job.id %>/ancestor/<%= ancestor.id %>/reresearch" method="POST" style="display:inline;"
                      onsubmit="return confirm('Reject this person and re-research? This will also remove all their descendants from the tree and re-run the research engine.');">
                    <button type="submit" class="btn btn-sm" style="background:#dc3545;color:white;border:none;padding:6px 14px;border-radius:6px;font-size:12px;cursor:pointer;">
                        Reject &amp; Re-Research
                    </button>
                </form>
            <% } else { %>
                <span class="badge badge-success">Customer Data &#10003;</span>
            <% } %>
        </div>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
        <div>
            <h2 style="margin-bottom:4px;"><%= ancestor.name %></h2>
            <%
              function getRelationToSubject(ascNum) {
                if (ascNum <= 1) return 'Subject';
                var isMale = (ascNum % 2 === 0);
                var n = ascNum;
                while (n > 3) { n = Math.floor(n / 2); }
                var side = (n === 2) ? 'Paternal' : 'Maternal';
                var gen = Math.floor(Math.log2(ascNum));
                if (gen === 1) return isMale ? 'Father' : 'Mother';
                if (gen === 2) return side + ' ' + (isMale ? 'Grandfather' : 'Grandmother');
                if (gen === 3) return side + ' Great-' + (isMale ? 'Grandfather' : 'Grandmother');
                var greats = gen - 2;
                return side + ' ' + greats + 'x Great-' + (isMale ? 'Grandfather' : 'Grandmother');
              }
              var relationToSubject = getRelationToSubject(ancestor.ascendancy_number);
            %>
            <div style="font-size:15px;color:var(--forest);font-weight:700;margin-top:4px;"><%= relationToSubject %></div>
            <span style="font-size:13px;color:var(--text-muted);">
                Ahnentafel #<%= ancestor.ascendancy_number %> &mdash; Generation <%= ancestor.generation %>
                &mdash; <%= ancestor.gender %>
            </span>
            <% if (ancestor.ascendancy_number > 1 && parentName) { %>
                <div style="font-size:12px;color:var(--sage);font-weight:600;margin-top:4px;">
                    <%= ancestor.ascendancy_number % 2 === 0 ? 'Father' : 'Mother' %> of <%= parentName %>
                </div>
            <% } %>
        </div>
        <%
          var badgeColor = ancestor.confidence_score >= 90 ? '#155724' : ancestor.confidence_score >= 75 ? '#1a5276' : ancestor.confidence_score >= 50 ? '#856404' : '#721c24';
          var badgeBg = ancestor.confidence_score >= 90 ? '#d4edda' : ancestor.confidence_score >= 75 ? '#d6eaf8' : ancestor.confidence_score >= 50 ? '#fff3cd' : '#f8d7da';
        %>
        <div style="display:flex;gap:8px;align-items:center;">
            <span style="display:inline-block;padding:6px 16px;border-radius:12px;font-size:14px;font-weight:700;background:<%= badgeBg %>;color:<%= badgeColor %>;">
                <%= ancestor.confidence_score %>% &mdash; <%= ancestor.confidence_level %>
            </span>
            <%
              var corrLog = ancestor.corrections_log || [];
              var hasActiveAICorrections = corrLog.some(function(c) { return c.source === 'ai_auto' && !c.undone; });
            %>
            <% if (hasActiveAICorrections) { %>
                <span style="display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700;background:#dbeafe;color:#1e40af;">
                    AI Auto-Corrected
                </span>
            <% } %>
        </div>
    </div>

    <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
        <% if (ancestor.birth_date || ancestor.birth_place) { %>
            <div><strong>Birth:</strong> <%= ancestor.birth_date %><%= ancestor.birth_place ? ', ' + ancestor.birth_place : '' %></div>
        <% } %>
        <% if (ancestor.death_date || ancestor.death_place) { %>
            <div><strong>Death:</strong> <%= ancestor.death_date %><%= ancestor.death_place ? ', ' + ancestor.death_place : '' %></div>
        <% } %>
        <% if (ancestor.fs_person_id) { %>
            <div><strong>FamilySearch ID:</strong>
                <a href="https://www.familysearch.org/tree/person/details/<%= ancestor.fs_person_id %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= ancestor.fs_person_id %></a>
            </div>
        <% } %>
    </div>
</div>

<%
  var missingInfo = ancestor.missing_info || [];
  if (typeof missingInfo === 'string') { try { missingInfo = JSON.parse(missingInfo); } catch(e) { missingInfo = []; } }
  if (!Array.isArray(missingInfo)) missingInfo = [];
%>
<% if (missingInfo.length > 0) { %>
<div class="card">
    <h3 style="margin-bottom:10px;color:var(--warning);">&#9888; Key Information Missing</h3>
    <% missingInfo.forEach(function(m) { %>
        <div style="padding:10px 14px;margin-bottom:8px;background:#fff3cd;border-left:4px solid #f39c12;border-radius:0 6px 6px 0;font-size:13px;color:#856404;">
            <%= m.message || m %>
        </div>
    <% }); %>

    <div style="margin-top:16px;padding:16px;background:var(--cream);border-radius:8px;">
        <h4 style="font-size:13px;margin-bottom:10px;color:var(--forest);">Update Information</h4>
        <form action="/admin/research/<%= job.id %>/ancestor/<%= ancestor.id %>/update-info" method="POST">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div>
                    <label style="font-size:11px;font-weight:600;display:block;margin-bottom:3px;">Birth Year</label>
                    <input type="text" name="birth_date" value="<%= ancestor.birth_date || '' %>" placeholder="e.g. 1875"
                        style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                </div>
                <div>
                    <label style="font-size:11px;font-weight:600;display:block;margin-bottom:3px;">Birth Place</label>
                    <input type="text" name="birth_place" value="<%= ancestor.birth_place || '' %>" placeholder="e.g. Pinxton, Derbyshire"
                        style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                </div>
                <div>
                    <label style="font-size:11px;font-weight:600;display:block;margin-bottom:3px;">Death Year</label>
                    <input type="text" name="death_date" value="<%= ancestor.death_date || '' %>" placeholder="e.g. 1958"
                        style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                </div>
                <div>
                    <label style="font-size:11px;font-weight:600;display:block;margin-bottom:3px;">Death Place</label>
                    <input type="text" name="death_place" value="<%= ancestor.death_place || '' %>" placeholder="e.g. Nottingham"
                        style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;">
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm" style="margin-top:10px;">Update &amp; Re-Score</button>
        </form>
    </div>
</div>
<% } %>

<% if (ancestor.verification_notes) { %>
<div class="card">
    <h3 style="margin-bottom:10px;">Why This Person Was Selected</h3>
    <div style="padding:12px;background:var(--cream);border-radius:8px;font-size:13px;line-height:1.6;">
        <% var noteLines = ancestor.verification_notes.split('. ').filter(function(n) { return n.trim(); }); %>
        <% noteLines.forEach(function(note) { %>
            <div style="margin-bottom:6px;padding-left:16px;position:relative;">
                <span style="position:absolute;left:0;color:var(--sage);font-weight:700;">&bull;</span>
                <%= note.endsWith('.') ? note : note + '.' %>
            </div>
        <% }); %>
    </div>
</div>
<% } %>

<% if (ancestor.raw_data && ancestor.raw_data.scoring_breakdown) { %>
<div class="card">
    <h3>Scoring Breakdown &mdash; Points-Based Confidence</h3>
    <%
      var sb = ancestor.raw_data.scoring_breakdown;
    %>
    <div style="margin-top:12px;padding:16px;background:var(--cream);border-radius:8px;">
        <table style="width:100%;font-size:13px;border-collapse:collapse;">
            <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:8px;">
                    <strong>Source Records</strong>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Civil registration, census, parish registers, military&hellip;</div>
                </td>
                <td style="padding:8px;text-align:right;font-weight:700;font-size:15px;"><%= sb.sources.points %> pts</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:8px;">
                    <strong>Person Facts</strong>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Birth, death, marriage, residence dates &amp; places</div>
                </td>
                <td style="padding:8px;text-align:right;font-weight:700;font-size:15px;"><%= sb.facts.points %> pts</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:8px;">
                    <strong>Family Context</strong>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Parent-child linkage, surname match</div>
                </td>
                <td style="padding:8px;text-align:right;font-weight:700;font-size:15px;"><%= sb.family.points %> pts</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:8px;">
                    <strong>Location &amp; Date</strong>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">County/town match, generational age plausibility</div>
                </td>
                <td style="padding:8px;text-align:right;font-weight:700;font-size:15px;"><%= sb.location.points %> pts</td>
            </tr>
            <tr style="background:var(--sage);color:white;">
                <td style="padding:8px;font-weight:700;">Total Points &rarr; Confidence</td>
                <td style="padding:8px;text-align:right;font-weight:700;font-size:16px;">
                    <%= sb.total_points %> pts &rarr; <%= ancestor.confidence_score %>%
                </td>
            </tr>
        </table>
        <div style="font-size:11px;color:var(--text-muted);margin-top:8px;">
            55+ pts = Verified (90-95%) &bull; 35-54 = Probable (75-89%) &bull; 15-34 = Possible (50-74%) &bull; 5-14 = Suggested (30-49%)
        </div>
    </div>
</div>
<% } else if (candidates && candidates.length > 0) { %>
<div class="card">
    <h3>Scoring Breakdown &mdash; Selected Candidate</h3>
    <%
      var selected = candidates.find(function(c) { return c.selected; });
      if (selected) {
    %>
    <div style="margin-top:12px;padding:16px;background:var(--cream);border-radius:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
                <strong style="font-size:15px;"><%= selected.name %></strong>
                <span style="font-size:12px;color:var(--text-muted);margin-left:8px;">(<%= selected.fs_person_id %>)</span>
            </div>
            <span style="font-size:18px;font-weight:700;color:var(--forest);"><%= selected.computed_score %>/100</span>
        </div>
        <div style="font-size:13px;color:var(--text-muted);">Legacy scoring â€” scored before points-based system was implemented.</div>
    </div>
    <% } %>
</div>
<% } %>

<% if (ancestor.evidence_chain && ancestor.evidence_chain.length > 0) { %>
<div class="card">
    <h3>Evidence Chain (<%= ancestor.evidence_chain.length %> sources)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Sources from FamilySearch that support this person's identity.</p>
    <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:8px;">
        <thead>
            <tr style="text-align:left;border-bottom:2px solid var(--border);">
                <th style="padding:8px;">Type</th>
                <th style="padding:8px;">Title</th>
                <th style="padding:8px;">Weight</th>
                <th style="padding:8px;">Citation</th>
            </tr>
        </thead>
        <tbody>
            <% ancestor.evidence_chain.forEach(function(e) { %>
                <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:8px;">
                        <span style="background:var(--cream);padding:2px 6px;border-radius:4px;font-size:11px;font-weight:600;">
                            <%= e.source_type || 'Record' %>
                        </span>
                    </td>
                    <td style="padding:8px;">
                        <% if (e.url) { %>
                            <a href="<%= e.url %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= e.title %></a>
                        <% } else { %>
                            <%= e.title %>
                        <% } %>
                    </td>
                    <td style="padding:8px;font-weight:600;"><%= e.weight || '&mdash;' %></td>
                    <td style="padding:8px;font-size:12px;color:var(--text-muted);max-width:300px;overflow:hidden;text-overflow:ellipsis;"><%= e.citation || '&mdash;' %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } else if (ancestor.confidence_level !== 'Customer Data') { %>
<div class="card">
    <h3>Evidence Chain</h3>
    <p style="font-size:13px;color:var(--text-muted);padding:12px 0;">No FamilySearch sources found for this person. The confidence is based solely on the search match score.</p>
</div>
<% } %>

<%
  var aiReview = ancestor.ai_review || {};
  var freebmdRes = ancestor.freebmd_results || {};
  var hasAiData = (aiReview.gpt || aiReview.claude);
  var hasFreebmd = (freebmdRes.birth || freebmdRes.death || freebmdRes.marriage || freebmdRes.note);
%>
<% if (hasAiData || hasFreebmd) { %>
<div class="card">
    <h3 style="color:#7c3aed;">AI Review & Cross-Reference</h3>

    <% if (hasFreebmd) { %>
        <div style="margin-top:10px;padding:10px 14px;background:#f8f9fa;border-radius:8px;font-size:13px;">
            <strong style="color:var(--forest);">FreeBMD Civil Registration:</strong>
            <% if (freebmdRes.note) { %>
                <div style="margin-top:4px;color:var(--text-muted);"><%= freebmdRes.note %></div>
            <% } %>
            <% if (freebmdRes.birth) { %>
                <div style="margin-top:6px;">
                    <strong>Birth:</strong>
                    <% if (freebmdRes.birth.matched) { %><span style="color:#155724;">&#10003; Confirmed &mdash; <%= freebmdRes.birth.entry %></span>
                    <% } else { %><span style="color:#856404;">&#10007; Not found (<%= freebmdRes.birth.searched || '' %>)</span><% } %>
                </div>
            <% } %>
            <% if (freebmdRes.death) { %>
                <div style="margin-top:4px;">
                    <strong>Death:</strong>
                    <% if (freebmdRes.death.matched) { %><span style="color:#155724;">&#10003; Confirmed &mdash; <%= freebmdRes.death.entry %></span>
                    <% } else { %><span style="color:#856404;">&#10007; Not found (<%= freebmdRes.death.searched || '' %>)</span><% } %>
                </div>
            <% } %>
            <% if (freebmdRes.marriage) { %>
                <div style="margin-top:4px;">
                    <strong>Marriage:</strong>
                    <% if (freebmdRes.marriage.matched) { %><span style="color:#155724;">&#10003; Confirmed &mdash; <%= freebmdRes.marriage.entry %></span>
                    <% } else { %><span style="color:#856404;">&#10007; Not found (<%= freebmdRes.marriage.searched || '' %>)</span><% } %>
                </div>
            <% } %>
        </div>
    <% } %>

    <% if (hasAiData) { %>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
            <% if (aiReview.gpt) { %>
            <div style="padding:10px 14px;background:#f0fdf4;border-radius:8px;border:1px solid #d1fae5;">
                <strong style="font-size:13px;color:#10a37f;">GPT-4o</strong>
                <% if (aiReview.gpt.confidence_adjustment && aiReview.gpt.confidence_adjustment !== 0) { %>
                    <span style="font-size:12px;color:<%= aiReview.gpt.confidence_adjustment > 0 ? '#155724' : '#721c24' %>;margin-left:6px;font-weight:700;">
                        (<%= aiReview.gpt.confidence_adjustment > 0 ? '+' : '' %><%= aiReview.gpt.confidence_adjustment %>)
                    </span>
                <% } %>
                <% if (aiReview.gpt.flags && aiReview.gpt.flags.length > 0) { %>
                    <% aiReview.gpt.flags.forEach(function(flag) {
                        var fc = flag.type === 'error' ? '#dc3545' : flag.type === 'warning' ? '#e67e22' : flag.type === 'confirmation' ? '#28a745' : '#6c757d';
                    %>
                        <div style="font-size:12px;margin-top:6px;color:<%= fc %>;">
                            <% if (flag.type === 'error') { %>&#9888;<% } else if (flag.type === 'warning') { %>&#9888;<% } else if (flag.type === 'confirmation') { %>&#10003;<% } else { %>&#8226;<% } %>
                            <%= flag.message %>
                            <% if (flag.suggested_correction) { %><br><em style="color:#1a5276;">Fix: <%= flag.suggested_correction %></em><% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div style="font-size:12px;margin-top:6px;color:#6c757d;">No issues flagged</div>
                <% } %>
                <% if (aiReview.gpt.freebmd_assessment) { %>
                    <div style="font-size:12px;margin-top:6px;color:#495057;font-style:italic;"><%= aiReview.gpt.freebmd_assessment %></div>
                <% } %>
            </div>
            <% } %>

            <% if (aiReview.claude) { %>
            <div style="padding:10px 14px;background:#fef5f0;border-radius:8px;border:1px solid #fde8dc;">
                <strong style="font-size:13px;color:#c96442;">Claude Sonnet</strong>
                <% if (aiReview.claude.confidence_adjustment && aiReview.claude.confidence_adjustment !== 0) { %>
                    <span style="font-size:12px;color:<%= aiReview.claude.confidence_adjustment > 0 ? '#155724' : '#721c24' %>;margin-left:6px;font-weight:700;">
                        (<%= aiReview.claude.confidence_adjustment > 0 ? '+' : '' %><%= aiReview.claude.confidence_adjustment %>)
                    </span>
                <% } %>
                <% if (aiReview.claude.flags && aiReview.claude.flags.length > 0) { %>
                    <% aiReview.claude.flags.forEach(function(flag) {
                        var fc = flag.type === 'error' ? '#dc3545' : flag.type === 'warning' ? '#e67e22' : flag.type === 'confirmation' ? '#28a745' : '#6c757d';
                    %>
                        <div style="font-size:12px;margin-top:6px;color:<%= fc %>;">
                            <% if (flag.type === 'error') { %>&#9888;<% } else if (flag.type === 'warning') { %>&#9888;<% } else if (flag.type === 'confirmation') { %>&#10003;<% } else { %>&#8226;<% } %>
                            <%= flag.message %>
                            <% if (flag.suggested_correction) { %><br><em style="color:#1a5276;">Fix: <%= flag.suggested_correction %></em><% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div style="font-size:12px;margin-top:6px;color:#6c757d;">No issues flagged</div>
                <% } %>
                <% if (aiReview.claude.freebmd_assessment) { %>
                    <div style="font-size:12px;margin-top:6px;color:#495057;font-style:italic;"><%= aiReview.claude.freebmd_assessment %></div>
                <% } %>
            </div>
            <% } %>
        </div>

        <%
          var allSuggestions = [];
          if (aiReview.gpt && aiReview.gpt.manual_lookup_suggestions) allSuggestions = allSuggestions.concat(aiReview.gpt.manual_lookup_suggestions);
          if (aiReview.claude && aiReview.claude.manual_lookup_suggestions) allSuggestions = allSuggestions.concat(aiReview.claude.manual_lookup_suggestions);
          var uniqueSuggestions = [];
          allSuggestions.forEach(function(s) { if (uniqueSuggestions.indexOf(s) === -1) uniqueSuggestions.push(s); });
        %>
        <% if (uniqueSuggestions.length > 0) { %>
            <div style="margin-top:12px;padding:10px 14px;background:#e8f4f8;border-radius:8px;">
                <strong style="font-size:13px;color:#1a5276;">Manual Lookup Suggestions:</strong>
                <ul style="margin:6px 0 0 16px;padding:0;font-size:12px;">
                    <% uniqueSuggestions.forEach(function(s) { %>
                        <li style="margin-bottom:4px;"><%= s %></li>
                    <% }); %>
                </ul>
            </div>
        <% } %>
    <% } %>
</div>
<% } %>

<% if (ancestor.search_log && ancestor.search_log.length > 0) { %>
<div class="card">
    <h3>Search Log (<%= ancestor.search_log.length %> passes)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Each pass searches FamilySearch with different criteria, from most specific to broadest.</p>
    <div style="margin-top:8px;">
        <% ancestor.search_log.forEach(function(s) { %>
            <div style="padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong>
                        <% if (s.pass === 0) { %>Direct Parent Lookup
                        <% } else if (s.strategy === 'exact') { %>Pass <%= s.pass %> &mdash; Exact (all fields + parents)
                        <% } else if (s.strategy === 'relaxed') { %>Pass <%= s.pass %> &mdash; Relaxed (name + dates + places)
                        <% } else if (s.strategy === 'first_name_only') { %>Pass <%= s.pass %> &mdash; First Name Only
                        <% } else if (s.strategy === 'name_year') { %>Pass <%= s.pass %> &mdash; Name + Year
                        <% } else if (s.strategy === 'name_place') { %>Pass <%= s.pass %> &mdash; Name + Place
                        <% } else if (s.strategy === 'name_only') { %>Pass <%= s.pass %> &mdash; Name Only (broadest)
                        <% } else if (s.strategy === 'nickname') { %>Pass <%= s.pass %> &mdash; Nickname/Variant
                        <% } else { %>Pass <%= s.pass %> &mdash; <%= s.strategy %>
                        <% } %>
                    </strong>
                    <span style="font-size:12px;color:<%= s.results_count > 0 ? 'var(--sage)' : 'var(--text-muted)' %>;font-weight:600;">
                        <%= s.results_count %> result(s)
                    </span>
                </div>
                <% if (s.query && typeof s.query === 'object') { %>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">
                        <% var queryParts = []; %>
                        <% if (s.query.givenName) queryParts.push('Name: ' + s.query.givenName + ' ' + (s.query.surname || '')); %>
                        <% if (s.query.birthDate) queryParts.push('Birth: ' + s.query.birthDate); %>
                        <% if (s.query.birthPlace) queryParts.push('Place: ' + s.query.birthPlace); %>
                        <% if (s.query.fatherGivenName) queryParts.push('Father: ' + s.query.fatherGivenName + ' ' + (s.query.fatherSurname || '')); %>
                        <% if (s.query.motherGivenName) queryParts.push('Mother: ' + s.query.motherGivenName + ' ' + (s.query.motherSurname || '')); %>
                        <%- queryParts.join(' &bull; ') %>
                    </div>
                <% } %>
                <% if (s.error) { %>
                    <div style="color:#dc3545;font-size:12px;margin-top:4px;">Error: <%= s.error %></div>
                <% } %>
            </div>
        <% }); %>
    </div>
</div>
<% } %>

<% if (candidates && candidates.length > 0) { %>
<%
  var hasSelected = candidates.some(function(c) { return c.selected; });
  var unselected = candidates.filter(function(c) { return !c.selected && !c.rejection_reason; });
  var rejected = candidates.filter(function(c) { return c.rejection_reason; });
%>
<div class="card">
    <h3>All Candidates Considered (<%= candidates.length %>)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">All people found during search. The highest-scoring candidate above 50% is selected.</p>

    <% if (!hasSelected && unselected.length > 0) { %>
        <div style="padding:12px 16px;margin-bottom:16px;background:#fff3cd;border-left:4px solid #f39c12;border-radius:0 6px 6px 0;font-size:13px;color:#856404;">
            <strong>No candidate selected.</strong> Review the alternatives below and select the best match, or reject all and request more info.
        </div>
    <% } %>

    <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:8px;">
        <thead>
            <tr style="text-align:left;border-bottom:2px solid var(--border);">
                <th style="padding:8px;">Name</th>
                <th style="padding:8px;">FS ID</th>
                <th style="padding:8px;">Pass</th>
                <th style="padding:8px;">FS Score</th>
                <th style="padding:8px;">Our Score</th>
                <th style="padding:8px;">Status</th>
                <th style="padding:8px;">Action</th>
            </tr>
        </thead>
        <tbody>
            <% candidates.forEach(function(c) { %>
                <tr style="border-bottom:1px solid var(--border);<%= c.selected ? 'background:#d4edda;' : c.rejection_reason ? 'background:#f8d7da;opacity:0.7;' : '' %>">
                    <td style="padding:8px;font-weight:<%= c.selected ? '700' : '400' %>;">
                        <%= c.name %>
                        <% if (c.raw_data && c.raw_data.display) { %>
                            <div style="font-size:11px;color:var(--text-muted);">
                                <% if (c.raw_data.display.birthDate) { %>b. <%= c.raw_data.display.birthDate %><% } %>
                                <% if (c.raw_data.display.birthPlace) { %>, <%= c.raw_data.display.birthPlace %><% } %>
                                <% if (c.raw_data.display.deathDate) { %> &mdash; d. <%= c.raw_data.display.deathDate %><% } %>
                            </div>
                        <% } %>
                    </td>
                    <td style="padding:8px;font-size:11px;">
                        <a href="https://www.familysearch.org/tree/person/details/<%= c.fs_person_id %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= c.fs_person_id %></a>
                    </td>
                    <td style="padding:8px;"><%= c.search_pass === 0 ? 'Direct' : c.search_pass %></td>
                    <td style="padding:8px;"><%= c.fs_score ? (typeof c.fs_score === 'number' ? c.fs_score.toFixed(1) : c.fs_score) : '&mdash;' %></td>
                    <td style="padding:8px;">
                        <span style="font-weight:700;color:<%= c.computed_score >= 50 ? 'var(--forest)' : '#dc3545' %>;"><%= c.computed_score %>/100</span>
                    </td>
                    <td style="padding:8px;">
                        <% if (c.selected) { %>
                            <span style="color:#155724;font-weight:600;">Selected &#10003;</span>
                        <% } else if (c.rejection_reason) { %>
                            <span style="color:#721c24;font-size:12px;"><%= c.rejection_reason %></span>
                        <% } else { %>
                            <span style="color:var(--text-muted);font-size:12px;">Available</span>
                        <% } %>
                    </td>
                    <td style="padding:8px;">
                        <% if (!c.selected && !c.rejection_reason && c.fs_person_id) { %>
                            <form action="/admin/research/<%= job.id %>/ancestor/<%= ancestor.ascendancy_number %>/select-candidate" method="POST" style="display:inline;"
                                  onsubmit="return confirm('Select <%= c.name %> for this position? This will replace the current ancestor.');">
                                <input type="hidden" name="candidate_id" value="<%= c.id %>">
                                <button type="submit" class="btn btn-primary btn-sm" style="font-size:11px;padding:3px 10px;">Select</button>
                            </form>
                        <% } else if (c.selected) { %>
                            <span style="font-size:11px;color:#155724;">Current</span>
                        <% } else { %>
                            <span style="font-size:11px;color:var(--text-muted);">&mdash;</span>
                        <% } %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } %>

<% if (ancestor.conflicts && ancestor.conflicts.length > 0) { %>
<div class="card">
    <h3 style="color:#dc3545;">Conflicts (<%= ancestor.conflicts.length %>)</h3>
    <% ancestor.conflicts.forEach(function(c) { %>
        <div style="padding:10px;border-bottom:1px solid var(--border);font-size:13px;">
            <strong><%= c.field %>:</strong> <%= c.description %>
        </div>
    <% }); %>
</div>
<% } %>

<%
  var corrections = ancestor.corrections_log || [];
%>
<% if (corrections.length > 0) { %>
<div class="card">
    <h3>Corrections Log (<%= corrections.length %>)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Chronological record of all changes to this ancestor's data.</p>
    <% corrections.forEach(function(c, idx) {
        var sourceColor = c.source === 'ai_auto' ? '#3b82f6' : c.source === 'admin_applied_suggestion' ? '#f59e0b' : '#28a745';
        var sourceBg = c.source === 'ai_auto' ? '#dbeafe' : c.source === 'admin_applied_suggestion' ? '#fef3c7' : '#d4edda';
        var sourceLabel = c.source === 'ai_auto' ? 'AI Auto' : c.source === 'admin_applied_suggestion' ? 'Admin (AI suggestion)' : 'Admin';
        var isUndone = c.undone;
    %>
        <div style="padding:10px 14px;border-bottom:1px solid var(--border);font-size:13px;<%= isUndone ? 'opacity:0.5;' : '' %>">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;background:<%= sourceBg %>;color:<%= sourceColor %>;"><%= sourceLabel %></span>
                    <% if (c.type === 'confidence_adjustment') { %>
                        <span <% if (isUndone) { %>style="text-decoration:line-through;"<% } %>>
                            Confidence: <%= c.old_value %>% &rarr; <%= c.new_value %>%
                        </span>
                    <% } else if (c.type === 'field_correction') { %>
                        <span <% if (isUndone) { %>style="text-decoration:line-through;"<% } %>>
                            <%= c.field %>: "<%= c.old_value || '(empty)' %>" &rarr; "<%= c.new_value %>"
                        </span>
                        <% if (c.freebmd_confirmed) { %><span style="font-size:11px;color:#155724;margin-left:4px;">FreeBMD confirmed</span><% } %>
                    <% } %>
                    <% if (isUndone) { %><span style="font-size:11px;color:#dc3545;margin-left:6px;">UNDONE</span><% } %>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:11px;color:var(--text-muted);"><%= c.applied_at ? new Date(c.applied_at).toLocaleDateString() : '' %></span>
                    <% if (!isUndone && c.source === 'ai_auto') { %>
                        <form action="/admin/research/<%= job.id %>/ancestor/<%= ancestor.ascendancy_number %>/undo-correction" method="POST" style="display:inline;">
                            <input type="hidden" name="correction_index" value="<%= idx %>">
                            <button type="submit" class="btn btn-sm" style="background:#dc3545;color:white;font-size:10px;padding:2px 8px;">Undo</button>
                        </form>
                    <% } %>
                </div>
            </div>
        </div>
    <% }); %>
</div>
<% } %>
