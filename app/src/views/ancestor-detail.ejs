<div class="card">
    <a href="/admin/research/<%= job.id %>" style="font-size:13px;color:var(--forest);text-decoration:underline;">&larr; Back to research results</a>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
        <div>
            <h2 style="margin-bottom:4px;"><%= ancestor.name %></h2>
            <span style="font-size:13px;color:var(--text-muted);">
                Ahnentafel #<%= ancestor.ascendancy_number %> &mdash; Generation <%= ancestor.generation %>
                &mdash; <%= ancestor.gender %>
            </span>
        </div>
        <%
          var badgeColor = ancestor.confidence_score >= 90 ? '#155724' : ancestor.confidence_score >= 75 ? '#1a5276' : ancestor.confidence_score >= 50 ? '#856404' : '#721c24';
          var badgeBg = ancestor.confidence_score >= 90 ? '#d4edda' : ancestor.confidence_score >= 75 ? '#d6eaf8' : ancestor.confidence_score >= 50 ? '#fff3cd' : '#f8d7da';
        %>
        <span style="display:inline-block;padding:6px 16px;border-radius:12px;font-size:14px;font-weight:700;background:<%= badgeBg %>;color:<%= badgeColor %>;">
            <%= ancestor.confidence_score %>% &mdash; <%= ancestor.confidence_level %>
        </span>
    </div>

    <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
        <% if (ancestor.birth_date || ancestor.birth_place) { %>
            <div><strong>Birth:</strong> <%= ancestor.birth_date %><%= ancestor.birth_place ? ', ' + ancestor.birth_place : '' %></div>
        <% } %>
        <% if (ancestor.death_date || ancestor.death_place) { %>
            <div><strong>Death:</strong> <%= ancestor.death_date %><%= ancestor.death_place ? ', ' + ancestor.death_place : '' %></div>
        <% } %>
        <% if (ancestor.fs_person_id) { %>
            <div><strong>FamilySearch ID:</strong> <%= ancestor.fs_person_id %></div>
        <% } %>
    </div>

    <% if (ancestor.verification_notes) { %>
        <div style="margin-top:12px;padding:12px;background:var(--cream);border-radius:8px;font-size:13px;">
            <strong>Verification Notes:</strong> <%= ancestor.verification_notes %>
        </div>
    <% } %>
</div>

<% if (ancestor.evidence_chain && ancestor.evidence_chain.length > 0) { %>
<div class="card">
    <h3>Evidence Chain (<%= ancestor.evidence_chain.length %> items)</h3>
    <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:12px;">
        <thead>
            <tr style="text-align:left;border-bottom:2px solid var(--border);">
                <th style="padding:8px;">Type</th>
                <th style="padding:8px;">Title</th>
                <th style="padding:8px;">Weight</th>
                <th style="padding:8px;">Citation</th>
            </tr>
        </thead>
        <tbody>
            <% ancestor.evidence_chain.forEach(function(e) { %>
                <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:8px;">
                        <span style="background:var(--cream);padding:2px 6px;border-radius:4px;font-size:11px;font-weight:600;">
                            <%= e.source_type %>
                        </span>
                    </td>
                    <td style="padding:8px;">
                        <% if (e.url) { %>
                            <a href="<%= e.url %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= e.title %></a>
                        <% } else { %>
                            <%= e.title %>
                        <% } %>
                    </td>
                    <td style="padding:8px;font-weight:600;"><%= e.weight %></td>
                    <td style="padding:8px;font-size:12px;color:var(--text-muted);"><%= e.citation || '&mdash;' %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } %>

<% if (ancestor.search_log && ancestor.search_log.length > 0) { %>
<div class="card">
    <h3>Search Log (<%= ancestor.search_log.length %> passes)</h3>
    <div style="margin-top:12px;">
        <% ancestor.search_log.forEach(function(s) { %>
            <div style="padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong>Pass <%= s.pass %> &mdash; <%= s.strategy %></strong>
                    <span style="font-size:12px;color:var(--text-muted);"><%= s.results_count %> result(s)</span>
                </div>
                <% if (s.error) { %>
                    <div style="color:#dc3545;font-size:12px;margin-top:4px;">Error: <%= s.error %></div>
                <% } %>
            </div>
        <% }); %>
    </div>
</div>
<% } %>

<% if (candidates && candidates.length > 0) { %>
<div class="card">
    <h3>Candidates Considered (<%= candidates.length %>)</h3>
    <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:12px;">
        <thead>
            <tr style="text-align:left;border-bottom:2px solid var(--border);">
                <th style="padding:8px;">Name</th>
                <th style="padding:8px;">FS ID</th>
                <th style="padding:8px;">Pass</th>
                <th style="padding:8px;">FS Score</th>
                <th style="padding:8px;">Our Score</th>
                <th style="padding:8px;">Status</th>
            </tr>
        </thead>
        <tbody>
            <% candidates.forEach(function(c) { %>
                <tr style="border-bottom:1px solid var(--border);<%= c.selected ? 'background:#d4edda;' : '' %>">
                    <td style="padding:8px;font-weight:<%= c.selected ? '700' : '400' %>;"><%= c.name %></td>
                    <td style="padding:8px;font-size:11px;"><%= c.fs_person_id %></td>
                    <td style="padding:8px;"><%= c.search_pass %></td>
                    <td style="padding:8px;"><%= c.fs_score ? c.fs_score.toFixed(1) : '&mdash;' %></td>
                    <td style="padding:8px;font-weight:700;"><%= c.computed_score %>/100</td>
                    <td style="padding:8px;">
                        <% if (c.selected) { %>
                            <span style="color:#155724;font-weight:600;">Selected</span>
                        <% } else { %>
                            <span style="color:#721c24;font-size:12px;"><%= c.rejection_reason || 'Not selected' %></span>
                        <% } %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } %>

<% if (ancestor.conflicts && ancestor.conflicts.length > 0) { %>
<div class="card">
    <h3 style="color:#dc3545;">Conflicts (<%= ancestor.conflicts.length %>)</h3>
    <% ancestor.conflicts.forEach(function(c) { %>
        <div style="padding:10px;border-bottom:1px solid var(--border);font-size:13px;">
            <strong><%= c.field %>:</strong> <%= c.description %>
        </div>
    <% }); %>
</div>
<% } %>
