<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
        <a href="/admin/research/<%= job.id %>" style="font-size:13px;color:var(--forest);text-decoration:underline;">&larr; Back to research results</a>
        <% if (ancestor.confidence_level !== 'Customer Data' && ancestor.ascendancy_number > 1) { %>
            <form action="/admin/research/<%= job.id %>/ancestor/<%= ancestor.id %>/reresearch" method="POST" style="display:inline;"
                  onsubmit="return confirm('Reject this person and re-research? This will also remove all their descendants from the tree and re-run the research engine.');">
                <button type="submit" class="btn btn-sm" style="background:#dc3545;color:white;border:none;padding:6px 14px;border-radius:6px;font-size:12px;cursor:pointer;">
                    Reject &amp; Re-Research
                </button>
            </form>
        <% } %>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
        <div>
            <h2 style="margin-bottom:4px;"><%= ancestor.name %></h2>
            <span style="font-size:13px;color:var(--text-muted);">
                Ahnentafel #<%= ancestor.ascendancy_number %> &mdash; Generation <%= ancestor.generation %>
                &mdash; <%= ancestor.gender %>
                <%
                  var genLabels = ['Subject', 'Parent', 'Grandparent', 'Great-Grandparent', '2x Great-Grandparent', '3x Great-Grandparent', '4x Great-Grandparent'];
                  if (genLabels[ancestor.generation]) {
                %>
                    &mdash; <em><%= genLabels[ancestor.generation] %></em>
                <% } %>
            </span>
            <% if (ancestor.ascendancy_number > 1 && parentName) { %>
                <div style="font-size:12px;color:var(--sage);font-weight:600;margin-top:4px;">
                    <%= ancestor.ascendancy_number % 2 === 0 ? 'Father' : 'Mother' %> of <%= parentName %>
                </div>
            <% } %>
        </div>
        <%
          var badgeColor = ancestor.confidence_score >= 90 ? '#155724' : ancestor.confidence_score >= 75 ? '#1a5276' : ancestor.confidence_score >= 50 ? '#856404' : '#721c24';
          var badgeBg = ancestor.confidence_score >= 90 ? '#d4edda' : ancestor.confidence_score >= 75 ? '#d6eaf8' : ancestor.confidence_score >= 50 ? '#fff3cd' : '#f8d7da';
        %>
        <span style="display:inline-block;padding:6px 16px;border-radius:12px;font-size:14px;font-weight:700;background:<%= badgeBg %>;color:<%= badgeColor %>;">
            <%= ancestor.confidence_score %>% &mdash; <%= ancestor.confidence_level %>
        </span>
    </div>

    <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
        <% if (ancestor.birth_date || ancestor.birth_place) { %>
            <div><strong>Birth:</strong> <%= ancestor.birth_date %><%= ancestor.birth_place ? ', ' + ancestor.birth_place : '' %></div>
        <% } %>
        <% if (ancestor.death_date || ancestor.death_place) { %>
            <div><strong>Death:</strong> <%= ancestor.death_date %><%= ancestor.death_place ? ', ' + ancestor.death_place : '' %></div>
        <% } %>
        <% if (ancestor.fs_person_id) { %>
            <div><strong>FamilySearch ID:</strong>
                <a href="https://www.familysearch.org/tree/person/details/<%= ancestor.fs_person_id %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= ancestor.fs_person_id %></a>
            </div>
        <% } %>
    </div>
</div>

<% if (ancestor.verification_notes) { %>
<div class="card">
    <h3 style="margin-bottom:10px;">Why This Person Was Selected</h3>
    <div style="padding:12px;background:var(--cream);border-radius:8px;font-size:13px;line-height:1.6;">
        <% var noteLines = ancestor.verification_notes.split('. ').filter(function(n) { return n.trim(); }); %>
        <% noteLines.forEach(function(note) { %>
            <div style="margin-bottom:6px;padding-left:16px;position:relative;">
                <span style="position:absolute;left:0;color:var(--sage);font-weight:700;">&bull;</span>
                <%= note.endsWith('.') ? note : note + '.' %>
            </div>
        <% }); %>
    </div>
</div>
<% } %>

<% if (candidates && candidates.length > 0) { %>
<div class="card">
    <h3>Scoring Breakdown &mdash; Selected Candidate</h3>
    <%
      var selected = candidates.find(function(c) { return c.selected; });
      if (selected) {
    %>
    <div style="margin-top:12px;padding:16px;background:var(--cream);border-radius:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
                <strong style="font-size:15px;"><%= selected.name %></strong>
                <span style="font-size:12px;color:var(--text-muted);margin-left:8px;">(<%= selected.fs_person_id %>)</span>
            </div>
            <span style="font-size:18px;font-weight:700;color:var(--forest);"><%= selected.computed_score %>/100</span>
        </div>

        <div style="font-size:13px;margin-bottom:8px;">
            <strong>Search Pass:</strong> <%= selected.search_pass === 0 ? 'Direct Parent Lookup (from FamilySearch tree)' : 'Pass ' + selected.search_pass %>
            <% if (selected.fs_score) { %>
                &nbsp;&bull;&nbsp; <strong>FamilySearch Relevance:</strong> <%= typeof selected.fs_score === 'number' ? selected.fs_score.toFixed(1) : selected.fs_score %>
            <% } %>
        </div>

        <%
          // Parse the verification notes to extract score breakdown
          var verNotes = (ancestor.verification_notes || '');
          var searchScoreMatch = verNotes.match(/Search score: (\d+)\/100/);
          var evidenceScoreMatch = verNotes.match(/Evidence score: (\d+)\/100/);
          var searchScore = searchScoreMatch ? parseInt(searchScoreMatch[1]) : selected.computed_score;
          var evidenceScore = evidenceScoreMatch ? parseInt(evidenceScoreMatch[1]) : 0;
          var hasTreeLink = verNotes.includes('Linked in FamilySearch tree');
        %>

        <div style="margin-top:12px;">
            <h4 style="font-size:13px;margin-bottom:8px;color:var(--forest);">Confidence Calculation</h4>
            <table style="width:100%;font-size:13px;border-collapse:collapse;">
                <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:6px 8px;"><strong>Search Score</strong> (name, dates, places, parents, gender match)</td>
                    <td style="padding:6px 8px;text-align:right;font-weight:700;"><%= searchScore %>/100</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:6px 8px;"><strong>Evidence Score</strong> (FamilySearch sources &amp; records)</td>
                    <td style="padding:6px 8px;text-align:right;font-weight:700;"><%= evidenceScore %>/100</td>
                </tr>
                <% if (hasTreeLink) { %>
                <tr style="border-bottom:1px solid var(--border);background:#d4edda;">
                    <td style="padding:6px 8px;"><strong>Tree Link Bonus</strong> (linked as parent in FamilySearch tree)</td>
                    <td style="padding:6px 8px;text-align:right;font-weight:700;color:#155724;">+30 bonus</td>
                </tr>
                <% } %>
                <tr style="background:var(--sage);color:white;">
                    <td style="padding:8px;font-weight:700;">Final Confidence</td>
                    <td style="padding:8px;text-align:right;font-weight:700;font-size:15px;"><%= ancestor.confidence_score %>%</td>
                </tr>
            </table>
            <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">
                Formula: (Search &times; 0.6) + (Evidence &times; 0.4)<%= hasTreeLink ? ' with tree-floor minimum of Search &times; 0.85' : '' %>
            </div>
        </div>
    </div>
    <% } %>
</div>
<% } %>

<% if (ancestor.evidence_chain && ancestor.evidence_chain.length > 0) { %>
<div class="card">
    <h3>Evidence Chain (<%= ancestor.evidence_chain.length %> sources)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Sources from FamilySearch that support this person's identity.</p>
    <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:8px;">
        <thead>
            <tr style="text-align:left;border-bottom:2px solid var(--border);">
                <th style="padding:8px;">Type</th>
                <th style="padding:8px;">Title</th>
                <th style="padding:8px;">Weight</th>
                <th style="padding:8px;">Citation</th>
            </tr>
        </thead>
        <tbody>
            <% ancestor.evidence_chain.forEach(function(e) { %>
                <tr style="border-bottom:1px solid var(--border);">
                    <td style="padding:8px;">
                        <span style="background:var(--cream);padding:2px 6px;border-radius:4px;font-size:11px;font-weight:600;">
                            <%= e.source_type || 'Record' %>
                        </span>
                    </td>
                    <td style="padding:8px;">
                        <% if (e.url) { %>
                            <a href="<%= e.url %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= e.title %></a>
                        <% } else { %>
                            <%= e.title %>
                        <% } %>
                    </td>
                    <td style="padding:8px;font-weight:600;"><%= e.weight || '&mdash;' %></td>
                    <td style="padding:8px;font-size:12px;color:var(--text-muted);max-width:300px;overflow:hidden;text-overflow:ellipsis;"><%= e.citation || '&mdash;' %></td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } else if (ancestor.confidence_level !== 'Customer Data') { %>
<div class="card">
    <h3>Evidence Chain</h3>
    <p style="font-size:13px;color:var(--text-muted);padding:12px 0;">No FamilySearch sources found for this person. The confidence is based solely on the search match score.</p>
</div>
<% } %>

<% if (ancestor.search_log && ancestor.search_log.length > 0) { %>
<div class="card">
    <h3>Search Log (<%= ancestor.search_log.length %> passes)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Each pass searches FamilySearch with different criteria, from most specific to broadest.</p>
    <div style="margin-top:8px;">
        <% ancestor.search_log.forEach(function(s) { %>
            <div style="padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong>
                        <% if (s.pass === 0) { %>Direct Parent Lookup
                        <% } else if (s.strategy === 'exact') { %>Pass <%= s.pass %> &mdash; Exact (all fields + parents)
                        <% } else if (s.strategy === 'relaxed') { %>Pass <%= s.pass %> &mdash; Relaxed (name + dates + places)
                        <% } else if (s.strategy === 'first_name_only') { %>Pass <%= s.pass %> &mdash; First Name Only
                        <% } else if (s.strategy === 'name_year') { %>Pass <%= s.pass %> &mdash; Name + Year
                        <% } else if (s.strategy === 'name_place') { %>Pass <%= s.pass %> &mdash; Name + Place
                        <% } else if (s.strategy === 'name_only') { %>Pass <%= s.pass %> &mdash; Name Only (broadest)
                        <% } else if (s.strategy === 'nickname') { %>Pass <%= s.pass %> &mdash; Nickname/Variant
                        <% } else { %>Pass <%= s.pass %> &mdash; <%= s.strategy %>
                        <% } %>
                    </strong>
                    <span style="font-size:12px;color:<%= s.results_count > 0 ? 'var(--sage)' : 'var(--text-muted)' %>;font-weight:600;">
                        <%= s.results_count %> result(s)
                    </span>
                </div>
                <% if (s.query && typeof s.query === 'object') { %>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">
                        <% var queryParts = []; %>
                        <% if (s.query.givenName) queryParts.push('Name: ' + s.query.givenName + ' ' + (s.query.surname || '')); %>
                        <% if (s.query.birthDate) queryParts.push('Birth: ' + s.query.birthDate); %>
                        <% if (s.query.birthPlace) queryParts.push('Place: ' + s.query.birthPlace); %>
                        <% if (s.query.fatherGivenName) queryParts.push('Father: ' + s.query.fatherGivenName + ' ' + (s.query.fatherSurname || '')); %>
                        <% if (s.query.motherGivenName) queryParts.push('Mother: ' + s.query.motherGivenName + ' ' + (s.query.motherSurname || '')); %>
                        <%- queryParts.join(' &bull; ') %>
                    </div>
                <% } %>
                <% if (s.error) { %>
                    <div style="color:#dc3545;font-size:12px;margin-top:4px;">Error: <%= s.error %></div>
                <% } %>
            </div>
        <% }); %>
    </div>
</div>
<% } %>

<% if (candidates && candidates.length > 0) { %>
<div class="card">
    <h3>All Candidates Considered (<%= candidates.length %>)</h3>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">All people found during search. The highest-scoring candidate above 50% is selected.</p>
    <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:8px;">
        <thead>
            <tr style="text-align:left;border-bottom:2px solid var(--border);">
                <th style="padding:8px;">Name</th>
                <th style="padding:8px;">FS ID</th>
                <th style="padding:8px;">Pass</th>
                <th style="padding:8px;">FS Score</th>
                <th style="padding:8px;">Our Score</th>
                <th style="padding:8px;">Status</th>
            </tr>
        </thead>
        <tbody>
            <% candidates.forEach(function(c) { %>
                <tr style="border-bottom:1px solid var(--border);<%= c.selected ? 'background:#d4edda;' : '' %>">
                    <td style="padding:8px;font-weight:<%= c.selected ? '700' : '400' %>;">
                        <%= c.name %>
                        <% if (c.raw_data && c.raw_data.display) { %>
                            <div style="font-size:11px;color:var(--text-muted);">
                                <% if (c.raw_data.display.birthDate) { %>b. <%= c.raw_data.display.birthDate %><% } %>
                                <% if (c.raw_data.display.birthPlace) { %>, <%= c.raw_data.display.birthPlace %><% } %>
                                <% if (c.raw_data.display.deathDate) { %> &mdash; d. <%= c.raw_data.display.deathDate %><% } %>
                            </div>
                        <% } %>
                    </td>
                    <td style="padding:8px;font-size:11px;">
                        <a href="https://www.familysearch.org/tree/person/details/<%= c.fs_person_id %>" target="_blank" rel="noopener" style="color:var(--forest);"><%= c.fs_person_id %></a>
                    </td>
                    <td style="padding:8px;"><%= c.search_pass === 0 ? 'Direct' : c.search_pass %></td>
                    <td style="padding:8px;"><%= c.fs_score ? (typeof c.fs_score === 'number' ? c.fs_score.toFixed(1) : c.fs_score) : '&mdash;' %></td>
                    <td style="padding:8px;">
                        <span style="font-weight:700;color:<%= c.computed_score >= 50 ? 'var(--forest)' : '#dc3545' %>;"><%= c.computed_score %>/100</span>
                    </td>
                    <td style="padding:8px;">
                        <% if (c.selected) { %>
                            <span style="color:#155724;font-weight:600;">Selected</span>
                        <% } else { %>
                            <span style="color:#721c24;font-size:12px;"><%= c.rejection_reason || 'Not selected' %></span>
                        <% } %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>
<% } %>

<% if (ancestor.conflicts && ancestor.conflicts.length > 0) { %>
<div class="card">
    <h3 style="color:#dc3545;">Conflicts (<%= ancestor.conflicts.length %>)</h3>
    <% ancestor.conflicts.forEach(function(c) { %>
        <div style="padding:10px;border-bottom:1px solid var(--border);font-size:13px;">
            <strong><%= c.field %>:</strong> <%= c.description %>
        </div>
    <% }); %>
</div>
<% } %>
