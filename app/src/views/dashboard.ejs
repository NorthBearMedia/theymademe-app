<% var flashError = typeof flashError !== 'undefined' ? flashError : null; %>
<% if (flashError) { %>
    <div class="flash-error"><%= flashError %></div>
<% } %>

<div class="stat-grid">
    <div class="stat-card">
        <div class="num"><%= stats.total %></div>
        <div class="label">Total Jobs</div>
    </div>
    <div class="stat-card">
        <div class="num"><%= stats.completed %></div>
        <div class="label">Completed</div>
    </div>
    <div class="stat-card">
        <div class="num"><%= stats.running %></div>
        <div class="label">Running</div>
    </div>
    <div class="stat-card">
        <div class="num"><%= stats.pending %></div>
        <div class="label">Pending</div>
    </div>
</div>

<div class="card">
    <h2>FamilySearch Connection</h2>
    <% if (fsConnected) { %>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span class="badge badge-success">Connected</span>
            <span style="font-size:13px;color:var(--text-muted);"><%= tokenData.hours_remaining %>h remaining</span>
        </div>
        <form action="/admin/familysearch/disconnect" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-secondary btn-sm">Disconnect</button>
        </form>
    <% } else { %>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span class="badge badge-danger">Not Connected</span>
        </div>
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:14px;">Connect to FamilySearch to start running research queries.</p>
        <a href="/admin/familysearch/connect" class="btn btn-primary btn-sm">Connect to FamilySearch</a>
    <% } %>
</div>

<div class="card">
    <h2>Geni.com Connection</h2>
    <% if (typeof geniConnected !== 'undefined' && geniConnected) { %>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span class="badge badge-success">Connected</span>
        </div>
        <form action="/admin/geni/disconnect" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-secondary btn-sm">Disconnect</button>
        </form>
    <% } else { %>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span class="badge badge-danger">Not Connected</span>
        </div>
        <p style="font-size:14px;color:var(--text-muted);margin-bottom:14px;">Connect to Geni.com (~180M profiles) for additional search results.</p>
        <% if (typeof geniConfigured !== 'undefined' && geniConfigured) { %>
            <a href="/admin/geni/connect" class="btn btn-primary btn-sm" style="margin-right:8px;">Connect via OAuth</a>
        <% } %>
        <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('geni-manual-token').style.display='block'" style="margin-bottom:12px;">Paste Token Manually</button>
        <div id="geni-manual-token" style="display:none;margin-top:12px;padding:14px;background:var(--bg-alt, #f8f9fa);border-radius:8px;">
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:10px;">
                <strong>Option 1:</strong> Go to <a href="https://www.geni.com/platform/developer/api_explorer" target="_blank" rel="noopener">Geni API Explorer</a>,
                log in, and copy the access token shown (look in the URL bar or a token field after any API call).
            </p>
            <p style="font-size:13px;color:var(--text-muted);margin-bottom:10px;">
                <strong>Option 2:</strong> If you have a Geni app registered, use your App Key as the client_id.
                The App Key should be ~40 characters (e.g. <code>zVRR6xzi...</code>).
            </p>
            <form action="/admin/geni/set-token" method="POST" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;">
                <div style="flex:1;min-width:250px;">
                    <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Access Token</label>
                    <input type="text" name="token" placeholder="Paste Geni access token here" required
                        style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px;">
                </div>
                <div style="min-width:200px;">
                    <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Refresh Token (optional)</label>
                    <input type="text" name="refresh_token" placeholder="Optional refresh token"
                        style="width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px;">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Save Token</button>
            </form>
        </div>
    <% } %>
</div>

<div class="card">
    <h2>FreeBMD (UK Civil Registration)</h2>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
        <span class="badge badge-success">Active</span>
    </div>
    <p style="font-size:14px;color:var(--text-muted);">FreeBMD provides confirmation of UK births, deaths, and marriages (1837-1983). No configuration needed â€” always available.</p>
</div>

<div class="card">
    <div class="header-row">
        <h2 style="margin-bottom:0;">Recent Research</h2>
        <a href="/admin/research/new" class="btn btn-primary btn-sm">+ New Research</a>
    </div>
    <% if (recentJobs.length > 0) { %>
        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Generations</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% recentJobs.forEach(function(j) { %>
                    <tr>
                        <td><strong><%= j.customer_name %></strong></td>
                        <td><%= j.generations %></td>
                        <td style="font-size:13px;font-weight:600;color:var(--forest);">
                            <% if (j.completion) { %>
                                <%= j.completion.accepted %>/<%= j.completion.total %>
                            <% } else { %>
                                &mdash;
                            <% } %>
                        </td>
                        <td>
                            <span class="badge <%= j.status === 'completed' ? 'badge-success' : j.status === 'running' ? 'badge-info' : j.status === 'failed' ? 'badge-danger' : 'badge-warning' %>"><%= j.status %></span>
                        </td>
                        <td style="color:var(--text-muted);font-size:13px;"><%= new Date(j.created_at).toLocaleDateString('en-GB') %></td>
                        <td style="white-space:nowrap;">
                            <a href="/admin/research/<%= j.id %>" class="btn btn-secondary btn-sm">View</a>
                            <% if (j.status === 'pending') { %>
                                <form action="/admin/research/<%= j.id %>/begin" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-primary btn-sm">Begin Research</button>
                                </form>
                            <% } %>
                            <% if (j.status === 'completed') { %>
                                <a href="/admin/export/gedcom/<%= j.id %>" class="btn btn-primary btn-sm">GEDCOM</a>
                            <% } %>
                            <form action="/admin/research/<%= j.id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Delete this research job for <%= j.customer_name %>? This cannot be undone.');">
                                <button type="submit" class="btn btn-sm" style="background:#dc3545;color:white;border:none;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;">Delete</button>
                            </form>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } else { %>
        <p style="color:var(--text-muted);font-size:14px;">No research jobs yet. Click "New Research" to get started.</p>
    <% } %>
</div>
