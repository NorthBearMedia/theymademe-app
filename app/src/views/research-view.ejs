<div class="card">
    <div class="header-row">
        <div>
            <h2 style="margin-bottom:4px;"><%= job.customer_name %></h2>
            <span style="font-size:13px;color:var(--text-muted);"><%= job.generations %> generations</span>
            <% if (job.customer_email) { %>
                <span style="font-size:13px;color:var(--text-muted);margin-left:12px;"><%= job.customer_email %></span>
            <% } %>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
            <span class="badge <%= job.status === 'completed' ? 'badge-success' : job.status === 'running' ? 'badge-info' : job.status === 'failed' ? 'badge-danger' : 'badge-warning' %>"><%= job.status %></span>
            <% if (job.status === 'completed') { %>
                <a href="/admin/export/gedcom/<%= job.id %>" class="btn btn-primary btn-sm">Download GEDCOM</a>
            <% } %>
        </div>
    </div>

    <% if (job.status === 'failed' && job.error_message) { %>
        <div class="flash-error" style="margin-top:12px;"><%= job.error_message %></div>
    <% } %>

    <% if (job.status === 'running') { %>
        <div id="fan-progress" style="margin-top:12px;">
            <div style="background:#e8e8e8;border-radius:8px;height:24px;overflow:hidden;margin-bottom:8px;">
                <% var pct = job.progress_total > 0 ? Math.round((job.progress_current || 0) / job.progress_total * 100) : 0; %>
                <div style="background:var(--sage);height:100%;width:<%= pct %>%;transition:width 0.5s ease;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                    <% if (pct > 15) { %>
                        <span style="color:white;font-size:11px;font-weight:700;"><%= pct %>%</span>
                    <% } %>
                </div>
            </div>
            <div style="font-size:13px;color:var(--forest);">
                <%= job.progress_message || 'Starting research...' %>
            </div>
        </div>
    <% } %>

    <% if (job.input_data) { %>
        <div style="margin-top:16px;padding:16px;background:var(--cream);border-radius:8px;">
            <h3 style="font-size:14px;color:var(--forest);margin-bottom:10px;">Search Details</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
                <% if (job.input_data.given_name) { %><div><strong>Given Name:</strong> <%= job.input_data.given_name %></div><% } %>
                <% if (job.input_data.surname) { %><div><strong>Surname:</strong> <%= job.input_data.surname %></div><% } %>
                <% if (job.input_data.birth_date) { %><div><strong>Birth:</strong> <%= job.input_data.birth_date %></div><% } %>
                <% if (job.input_data.birth_place) { %><div><strong>Birth Place:</strong> <%= job.input_data.birth_place %></div><% } %>
                <% if (job.input_data.death_date) { %><div><strong>Death:</strong> <%= job.input_data.death_date %></div><% } %>
                <% if (job.input_data.death_place) { %><div><strong>Death Place:</strong> <%= job.input_data.death_place %></div><% } %>
                <% if (job.input_data.father_name) { %><div><strong>Father:</strong> <%= job.input_data.father_name %></div><% } %>
                <% if (job.input_data.mother_name) { %><div><strong>Mother:</strong> <%= job.input_data.mother_name %></div><% } %>
            </div>
            <% if (job.input_data.notes) { %>
                <div style="margin-top:8px;font-size:13px;"><strong>Notes:</strong> <%= job.input_data.notes %></div>
            <% } %>
        </div>
    <% } %>
</div>

<div class="card">
    <h2>Family Tree</h2>
    <div id="fan-chart-container" class="fan-chart-wrap"></div>
    <% if (job.status !== 'running') { %>
        <div id="fan-progress"></div>
    <% } %>
    <div class="fan-legend">
        <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#d4edda;"></div> Verified (90+%)</div>
        <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#d6eaf8;"></div> Probable (75-89%)</div>
        <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#fff3cd;"></div> Possible (50-74%)</div>
        <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#e8daef;"></div> Customer Data</div>
        <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#f8d7da;"></div> Rejected</div>
        <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#f0e8da;"></div> Empty</div>
    </div>
</div>

<script src="/fan-chart.js"></script>
<script>
(function () {
  var container = document.getElementById('fan-chart-container');
  var progressEl = document.getElementById('fan-progress');
  var jobId = '<%= job.id %>';
  var generations = <%= job.generations || 4 %>;
  var status = '<%= job.status %>';

  // Initial render with server-side data
  var initialAncestors = <%- JSON.stringify(ancestors.map(function(a) {
    return {
      id: a.id,
      ascendancy_number: a.ascendancy_number,
      generation: a.generation,
      name: a.name,
      gender: a.gender,
      birth_date: a.birth_date,
      birth_place: a.birth_place,
      death_date: a.death_date,
      death_place: a.death_place,
      fs_person_id: a.fs_person_id,
      confidence_score: a.confidence_score,
      confidence_level: a.confidence_level
    };
  })) %>;

  FanChart.render(container, jobId, generations, initialAncestors);

  // Start polling if research is running
  if (status === 'running' || status === 'pending') {
    FanChart.startPolling(container, jobId, generations, progressEl);
  }
})();
</script>

<% if (ancestors.length > 0) { %>
<%
  var verified = ancestors.filter(function(a) { return a.confidence_score >= 90; }).length;
  var probable = ancestors.filter(function(a) { return a.confidence_score >= 75 && a.confidence_score < 90; }).length;
  var possible = ancestors.filter(function(a) { return a.confidence_score >= 50 && a.confidence_score < 75; }).length;
  var rejected = ancestors.filter(function(a) { return a.confidence_score < 50; }).length;
%>
<div class="card">
    <h2>Ancestors Found (<%= ancestors.filter(function(a) { return a.confidence_score >= 50; }).length %> verified, <%= rejected %> rejected)</h2>

    <div style="display:flex;gap:16px;margin:12px 0 20px;flex-wrap:wrap;">
        <div style="background:#d4edda;color:#155724;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;">
            <%= verified %> Verified
        </div>
        <div style="background:#d6eaf8;color:#1a5276;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;">
            <%= probable %> Probable
        </div>
        <div style="background:#fff3cd;color:#856404;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;">
            <%= possible %> Possible
        </div>
        <div style="background:#f8d7da;color:#721c24;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;">
            <%= rejected %> Rejected
        </div>
    </div>

    <div class="ancestor-tree">
        <% var currentGen = -1; %>
        <% ancestors.forEach(function(a) { %>
            <% if (a.generation !== currentGen) { currentGen = a.generation; %>
                <div style="font-size:12px;font-weight:700;color:var(--sage);margin-top:18px;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">
                    Generation <%= a.generation %><%= a.generation === 0 ? ' (Subject)' : '' %>
                </div>
            <% } %>
            <%
              var isRejected = a.confidence_score < 50;
              var badgeColor = a.confidence_score >= 90 ? '#155724' : a.confidence_score >= 75 ? '#1a5276' : a.confidence_score >= 50 ? '#856404' : '#721c24';
              var badgeBg = a.confidence_score >= 90 ? '#d4edda' : a.confidence_score >= 75 ? '#d6eaf8' : a.confidence_score >= 50 ? '#fff3cd' : '#f8d7da';
            %>
            <div class="ancestor-row" style="margin-left:<%= Math.min(a.generation * 16, 96) %>px;<%= isRejected ? 'opacity:0.5;' : '' %>">
                <span class="gen">#<%= a.ascendancy_number %></span>
                <span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;background:<%= badgeBg %>;color:<%= badgeColor %>;margin-right:8px;white-space:nowrap;">
                    <%= a.confidence_score %>% &mdash; <%= a.confidence_level || 'Unknown' %>
                </span>
                <div>
                    <div class="name"><%= a.name %> <span style="font-weight:400;font-size:12px;color:var(--text-muted);">(<%= a.gender %>)</span></div>
                    <div class="details">
                        <% if (a.birth_date || a.birth_place) { %>
                            b. <%= a.birth_date %><%= a.birth_place ? ', ' + a.birth_place : '' %>
                        <% } %>
                        <% if (a.death_date || a.death_place) { %>
                            &nbsp;|&nbsp; d. <%= a.death_date %><%= a.death_place ? ', ' + a.death_place : '' %>
                        <% } %>
                    </div>
                    <div style="font-size:11px;margin-top:3px;display:flex;gap:12px;align-items:center;">
                        <% if (a.sources && a.sources.length > 0) { %>
                            <span style="color:var(--info);"><%= a.sources.length %> source(s)</span>
                        <% } %>
                        <% if (a.evidence_chain && a.evidence_chain.length > 0) { %>
                            <span style="color:var(--sage);"><%= a.evidence_chain.length %> evidence items</span>
                        <% } %>
                        <a href="/admin/research/<%= job.id %>/ancestor/<%= a.id %>" style="color:var(--forest);text-decoration:underline;font-size:11px;">View Evidence</a>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>
</div>
<% } %>
