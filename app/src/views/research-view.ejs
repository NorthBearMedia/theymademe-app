<div class="card">
    <div class="header-row">
        <div>
            <h2 style="margin-bottom:4px;"><%= job.customer_name %></h2>
            <span style="font-size:13px;color:var(--text-muted);"><%= job.generations %> generations</span>
            <% if (job.customer_email) { %>
                <span style="font-size:13px;color:var(--text-muted);margin-left:12px;"><%= job.customer_email %></span>
            <% } %>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
            <span class="badge <%= job.status === 'completed' ? 'badge-success' : job.status === 'running' ? 'badge-info' : job.status === 'failed' ? 'badge-danger' : 'badge-warning' %>"><%= job.status %></span>
            <% if (job.status === 'pending') { %>
                <form action="/admin/research/<%= job.id %>/begin" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-primary btn-sm">Begin Research</button>
                </form>
            <% } %>
            <% if (job.status === 'completed') { %>
                <a href="/admin/research/<%= job.id %>/ai-review" class="btn btn-sm" style="background:#7c3aed;color:white;border:none;padding:6px 14px;border-radius:6px;font-size:12px;cursor:pointer;">
                    AI Review
                    <% if (job.ai_review_status === 'completed') { %> &#10003;<% } else if (job.ai_review_status === 'running') { %> ...<% } %>
                </a>
                <a href="/admin/export/pdf/<%= job.id %>/preview" target="_blank" class="btn btn-primary btn-sm">Preview PDF</a>
                <a href="/admin/export/pdf/<%= job.id %>" class="btn btn-primary btn-sm">Download PDF</a>
                <a href="/admin/export/gedcom/<%= job.id %>" class="btn btn-secondary btn-sm">GEDCOM</a>
            <% } %>
        </div>
    </div>

    <% if (job.status === 'failed' && job.error_message) { %>
        <div class="flash-error" style="margin-top:12px;"><%= job.error_message %></div>
    <% } %>

    <% if (job.status === 'running') { %>
        <div id="fan-progress" style="margin-top:12px;">
            <div style="background:#e8e8e8;border-radius:8px;height:24px;overflow:hidden;margin-bottom:8px;">
                <% var pct = job.progress_total > 0 ? Math.round((job.progress_current || 0) / job.progress_total * 100) : 0; %>
                <div style="background:var(--sage);height:100%;width:<%= pct %>%;transition:width 0.5s ease;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                    <% if (pct > 15) { %>
                        <span style="color:white;font-size:11px;font-weight:700;"><%= pct %>%</span>
                    <% } %>
                </div>
            </div>
            <div style="font-size:13px;color:var(--forest);">
                <%= job.progress_message || 'Starting research...' %>
            </div>
        </div>
    <% } %>

    <% if (job.input_data) { %>
        <div style="margin-top:16px;padding:16px;background:var(--cream);border-radius:8px;">
            <h3 style="font-size:14px;color:var(--forest);margin-bottom:10px;">Search Details</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">
                <% if (job.input_data.given_name) { %><div><strong>Given Name:</strong> <%= job.input_data.given_name %></div><% } %>
                <% if (job.input_data.surname) { %><div><strong>Surname:</strong> <%= job.input_data.surname %></div><% } %>
                <% if (job.input_data.birth_date) { %><div><strong>Birth:</strong> <%= job.input_data.birth_date %></div><% } %>
                <% if (job.input_data.birth_place) { %><div><strong>Birth Place:</strong> <%= job.input_data.birth_place %></div><% } %>
                <% if (job.input_data.death_date) { %><div><strong>Death:</strong> <%= job.input_data.death_date %></div><% } %>
                <% if (job.input_data.death_place) { %><div><strong>Death Place:</strong> <%= job.input_data.death_place %></div><% } %>
                <% if (job.input_data.father_name) { %><div><strong>Father:</strong> <%= job.input_data.father_name %></div><% } %>
                <% if (job.input_data.mother_name) { %><div><strong>Mother:</strong> <%= job.input_data.mother_name %></div><% } %>
            </div>
            <% if (job.input_data.notes) { %>
                <div style="margin-top:8px;font-size:13px;"><strong>Notes:</strong> <%= job.input_data.notes %></div>
            <% } %>
        </div>
    <% } %>
</div>

<%
  // Compute completion counter
  var totalSlots = Math.pow(2, (job.generations || 4) + 1) - 1;
  var acceptedCount = ancestors.filter(function(a) { return a.accepted || a.confidence_level === 'Customer Data'; }).length;
  var acceptedPct = totalSlots > 0 ? Math.round(acceptedCount / totalSlots * 100) : 0;
%>

<!-- Completion Counter -->
<div class="completion-counter">
    <div class="counter-text">Tree Progress: <span id="completion-count"><%= acceptedCount %></span>/<%= totalSlots %> accepted</div>
    <div class="counter-bar">
        <div class="counter-fill" id="completion-fill" style="width:<%= acceptedPct %>%;"></div>
    </div>
</div>

<!-- View Toggle + Tree -->
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h2 style="margin-bottom:0;">Family Tree</h2>
        <div class="view-toggle">
            <button class="view-toggle-btn active" id="btn-tree-view" onclick="switchView('tree')">Tree View</button>
            <button class="view-toggle-btn" id="btn-fan-view" onclick="switchView('fan')">Fan Chart</button>
        </div>
    </div>

    <!-- Tree Cards View (default) -->
    <div id="tree-container"></div>

    <!-- Fan Chart View (hidden by default) -->
    <div id="fan-view-container" style="display:none;">
        <div id="fan-chart-container" class="fan-chart-wrap"></div>
        <div class="fan-legend">
            <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#d4edda;"></div> Verified (90+%)</div>
            <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#d6eaf8;"></div> Probable (75-89%)</div>
            <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#fff3cd;"></div> Possible (50-74%)</div>
            <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#e8daef;"></div> Customer Data</div>
            <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#fce4ec;"></div> Suggested</div>
            <div class="fan-legend-item"><div class="fan-legend-swatch" style="background:#f0e8da;"></div> Empty</div>
        </div>
    </div>

    <% if (job.status === 'running' || job.status === 'pending') { %>
        <div id="fan-progress" style="margin-top:12px;">
            <div style="background:#e8e8e8;border-radius:8px;height:20px;overflow:hidden;margin-bottom:6px;">
                <% var pct = job.progress_total > 0 ? Math.round((job.progress_current || 0) / job.progress_total * 100) : 0; %>
                <div style="background:var(--sage);height:100%;width:<%= pct %>%;transition:width 0.5s ease;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                    <% if (pct > 15) { %>
                        <span style="color:white;font-size:10px;font-weight:700;"><%= pct %>%</span>
                    <% } %>
                </div>
            </div>
            <div style="font-size:13px;color:var(--forest);"><%= job.progress_message || 'Starting research...' %></div>
        </div>
    <% } else { %>
        <div id="fan-progress"></div>
    <% } %>
</div>

<script src="/admin/static/fan-chart.js"></script>
<script src="/admin/static/tree-cards.js"></script>
<script>
(function () {
  var treeContainer = document.getElementById('tree-container');
  var fanContainer = document.getElementById('fan-chart-container');
  var progressEl = document.getElementById('fan-progress');
  var counterEl = document.getElementById('completion-count');
  var counterFill = document.getElementById('completion-fill');
  var jobId = '<%= job.id %>';
  var generations = <%= job.generations || 4 %>;
  var totalSlots = <%= totalSlots %>;
  var status = '<%= job.status %>';

  // Initial ancestor data with accepted + missing_info fields
  var initialAncestors = <%- JSON.stringify(ancestors.map(function(a) {
    return {
      id: a.id,
      ascendancy_number: a.ascendancy_number,
      generation: a.generation,
      name: a.name,
      gender: a.gender,
      birth_date: a.birth_date,
      birth_place: a.birth_place,
      death_date: a.death_date,
      death_place: a.death_place,
      fs_person_id: a.fs_person_id,
      confidence_score: a.confidence_score,
      confidence_level: a.confidence_level,
      accepted: a.accepted || 0,
      missing_info: a.missing_info || []
    };
  })) %>;

  // Render both views initially
  TreeCards.render(treeContainer, jobId, generations, initialAncestors);
  FanChart.render(fanContainer, jobId, generations, initialAncestors);

  // Start polling if research is running
  if (status === 'running' || status === 'pending') {
    TreeCards.startPolling(treeContainer, jobId, generations, progressEl, counterEl);
  }

  // View toggle
  window.switchView = function(view) {
    var treeView = document.getElementById('tree-container');
    var fanView = document.getElementById('fan-view-container');
    var btnTree = document.getElementById('btn-tree-view');
    var btnFan = document.getElementById('btn-fan-view');
    if (view === 'fan') {
      treeView.style.display = 'none';
      fanView.style.display = 'block';
      btnFan.classList.add('active');
      btnTree.classList.remove('active');
    } else {
      treeView.style.display = 'block';
      fanView.style.display = 'none';
      btnTree.classList.add('active');
      btnFan.classList.remove('active');
    }
  };
})();
</script>
